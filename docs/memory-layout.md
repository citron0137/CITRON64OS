# CITRON64OS 메모리 레이아웃 분석

## 📋 개요

CITRON64OS는 16비트 실제 모드에서 시작하여 32비트 보호 모드를 거쳐 64비트 롱 모드로 전환하는 멀티스테이지 부팅 시스템입니다.

## 🚀 부팅 단계별 메모리 레이아웃

### **1단계: 16비트 실제 모드 (Real Mode) - 0x00000 ~ 0xFFFFF**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             1MB 메모리 공간 (0x00000 ~ 0xFFFFF)            │
├─────────────────────────────────────────────────────────────────────────────┤
│ 0x00000 ┌─────────────────────────────────────────────────────────────┐   │
│          │                    스택 영역                               │   │
│          │              (0x0000:0000 ~ 0x0000:FFFF)                  │   │
│ 0x10000 └─────────────────────────────────────────────────────────────┘   │
│                                                                             │
│ 0x07C000┌─────────────────────────────────────────────────────────────┐   │
│          │                  부트로더 (512바이트)                      │   │
│          │              (0x07C0:0000 ~ 0x07C0:01FF)                  │   │
│ 0x07E000└─────────────────────────────────────────────────────────────┘   │
│                                                                             │
│ 0x0B8000┌─────────────────────────────────────────────────────────────┐   │
│          │                 비디오 메모리                              │   │
│          │              (0xB800:0000 ~ 0xB800:FFFF)                  │   │
│ 0x0BC000└─────────────────────────────────────────────────────────────┘   │
│                                                                             │
│ 0x100000┌─────────────────────────────────────────────────────────────┐   │
│          │              32비트 커널 로딩 시작                        │   │
│          │              Kernel32.bin (1024 섹터)                     │   │
│ 0x200000└─────────────────────────────────────────────────────────────┘   │
│                                                                             │
│ 0x200000┌─────────────────────────────────────────────────────────────┐   │
│          │              64비트 커널 로딩 시작                        │   │
│          │              Kernel64.bin (1024 섹터)                     │   │
│ 0x300000└─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### **실제 모드 메모리 맵**
| 주소 범위 | 크기 | 용도 | 설명 |
|-----------|------|------|------|
| `0x00000` ~ `0x0FFFF` | 64KB | 스택 | 부트로더 스택 영역 |
| `0x7C000` ~ `0x7DFFF` | 8KB | 부트로더 | 512바이트 부트로더 코드 |
| `0xB8000` ~ `0xBFFFF` | 32KB | 비디오 메모리 | 텍스트 모드 화면 출력 |
| `0x100000` ~ `0x1FFFFF` | 1MB | 32비트 커널 | Kernel32.bin 로딩 영역 |
| `0x200000` ~ `0x2FFFFF` | 1MB | 64비트 커널 | Kernel64.bin 로딩 영역 |

### **2단계: 32비트 보호 모드 (Protected Mode) - 0x00000000 ~ 0xFFFFFFFF**

#### **세그먼트 설정**
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           32비트 보호 모드 세그먼트                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ CS = 0x0008 │ 00000000 │ FFFFFFFF │ 00CF9B00 │ DPL=0 │ 32비트 코드 세그먼트 │
│ DS = 0x0010 │ 00000000 │ FFFFFFFF │ 00CF9300 │ DPL=0 │ 32비트 데이터 세그먼트 │
│ SS = 0x0010 │ 00000000 │ FFFFFFFF │ 00CF9300 │ DPL=0 │ 32비트 스택 세그먼트 │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### **컨트롤 레지스터 상태**
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           32비트 보호 모드 레지스터                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ CR0 = 0x00000011 │ PE=1 (보호 모드) │ PG=0 (페이징 비활성화)              │
│ CR3 = 0x00000000 │ 페이지 디렉토리 베이스 없음                            │
│ CR4 = 0x00000000 │ PAE 비활성화                                          │
│ EFER = 0x0000000000000000 │ Long Mode 비활성화                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### **메모리 매핑**
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          4GB 메모리 공간 (32비트)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ 0x00000000 ┌─────────────────────────────────────────────────────────────┐ │
│             │                    1MB 하위 메모리                          │ │
│             │              (실제 모드와 동일한 레이아웃)                  │ │
│ 0x00100000 └─────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ 0x00100000 ┌─────────────────────────────────────────────────────────────┐ │
│             │                 32비트 커널 영역                            │ │
│             │              (0x00100000 ~ 0x001FFFFF)                     │ │
│ 0x00200000 └─────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ 0x00200000 ┌─────────────────────────────────────────────────────────────┐ │
│             │                 64비트 커널 영역                            │ │
│             │              (0x00200000 ~ 0x002FFFFF)                     │ │
│ 0x00300000 └─────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ 0x00300000 ┌─────────────────────────────────────────────────────────────┐ │
│             │                    사용 가능한 메모리                       │ │
│             │              (0x00300000 ~ 0xFFFFFFFF)                     │ │
│ 0xFFFFFFFF └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

### **3단계: 64비트 롱 모드 (Long Mode) - 0x0000000000000000 ~ 0xFFFFFFFFFFFFFFFF**

#### **세그먼트 설정**
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           64비트 롱 모드 세그먼트                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ CS = 0x0008 │ 0000000000000000 │ FFFFFFFF │ 00AF9A00 │ DPL=0 │ 64비트 코드 세그먼트 │
│ DS = 0x0020 │ 0000000000000000 │ FFFFFFFF │ 00CF9300 │ DPL=0 │ 64비트 데이터 세그먼트 │
│ SS = 0x0020 │ 0000000000000000 │ FFFFFFFF │ 00CF9300 │ DPL=0 │ 64비트 스택 세그먼트 │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### **컨트롤 레지스터 상태**
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           64비트 롱 모드 레지스터                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ CR0 = 0x8000003B │ PE=1 (보호 모드) │ PG=1 (페이징 활성화)                │
│ CR3 = 0x0000000000100000 │ 페이지 디렉토리 베이스: 1MB (0x100000)        │
│ CR4 = 0x00000020 │ PAE 활성화 (Physical Address Extension)                │
│ EFER = 0x0000000000000500 │ LME=1 (Long Mode Enable)                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### **4단계 페이지 테이블 구조**
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        4단계 페이지 테이블 구조                            │
├─────────────────────────────────────────────────────────────────────────────┤
│ 0x00100000 ┌─────────────────────────────────────────────────────────────┐ │
│             │                    PML4 테이블 (Level 4)                   │ │
│             │               페이지 맵 레벨 4 테이블                      │ │
│ 0x00100FFF └─────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ 0x00101000 ┌─────────────────────────────────────────────────────────────┐ │
│             │                    PDP 테이블 (Level 3)                     │ │
│             │               페이지 디렉토리 포인터 테이블                  │ │
│ 0x00101FFF └─────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ 0x00102000 ┌─────────────────────────────────────────────────────────────┐ │
│             │                    PD 테이블 (Level 2)                      │ │
│             │                 페이지 디렉토리 테이블                      │ │
│ 0x00102FFF └─────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ 0x00103000 ┌─────────────────────────────────────────────────────────────┐ │
│             │                    PT 테이블 (Level 1)                      │ │
│             │                   페이지 테이블                             │ │
│ 0x00103FFF └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### **64비트 주소 공간 매핑**
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       64비트 가상 주소 공간                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ 0x0000000000000000 ┌─────────────────────────────────────────────────────┐ │
│                     │                    하위 4GB                        │ │
│                     │              (물리 메모리와 1:1 매핑)              │ │
│ 0x00000000FFFFFFFF └─────────────────────────────────────────────────────┘ │
│                                                                             │
│ 0x0000000100000000 ┌─────────────────────────────────────────────────────┐ │
│                     │                    상위 4GB                        │ │
│                     │              (현재 매핑되지 않음 - 문제!)            │ │
│ 0x00000001FFFFFFFF └─────────────────────────────────────────────────────┘ │
│                                                                             │
│ 0x4100000000000000 ┌─────────────────────────────────────────────────────┐ │
│                     │                64비트 커널 실행 영역                │ │
│                     │         (Page Fault 발생 지점 - 0x4100000000010436) │ │
│ 0x410000000001FFFF └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

